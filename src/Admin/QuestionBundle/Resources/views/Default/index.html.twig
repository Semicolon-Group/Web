{% extends 'admin_base.html.twig' %}
{% block title %}Admin | Questions{% endblock %}
{% block page_title %}Questions{% endblock %}
{% block stylesheets %}
    <link href="{{ asset('member_assets/css/card.css') }}" rel="stylesheet">
{% endblock %}
{% block body %}
    <div id="question-form-modal" class="modal fade centered-modal" role="dialog" style="margin-top: 5vh;">
        <div class="modal-dialog" style="width: 70%;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">New Question</h4>
                </div>
                <div class="modal-body">
                    <div class="row card-container" style="width: 100%;">
                        <div class="col-md-12">
                            <div class="card horizontal" style="height: 70vh;">
                                <div class="card-stacked">
                                    <form id="new_answer_form">
                                        <div class="card-content" style="align-content: center; max-height: 100%; min-height: 62vh">
                                            <div class="row" style=" position:relative;left: 50%;transform: translate(-50%); width: 70%; height: 100%; max-height: 100%; overflow-y: auto;">
                                                <form id="question-form">
                                                    <div class="form-group">
                                                        <label for="topic">Topic:</label>
                                                        <select id="topic" class="form-control" required>
                                                            <option value="null" disabled selected>Select a topic</option>
                                                            <option value="0">Topic 1</option>
                                                            <option value="1">Topic 2</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="question">Question:</label>
                                                        <input class="form-control" id="question" type="text" placeholder="Question" required/>
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Choices:</label><br/>
                                                        <input style="display: inline-block; width: 50%;" type="text" class="form-control choice" placeholder="Choice" id="ch-0"/><span id="add-0" style="margin-left: 10px; font-size: large;" class="lnr lnr-plus-circle hoverable choice-add"></span>
                                                        <div id="choices"></div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                        <div class="card-action">
                                            <button id="answer-add-btn" type="submit" style="float: right;" class="btn btn-default">Add</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel-body" style="min-height: 68vh;">
            <h3 class="lnr lnr-plus-circle hoverable" id="add_question-btn" style="float: right;"></h3>
        <table class="table table-hover" style="width: 100%;">
            <thead>
            <tr>
                <th>#</th>
                <th>Question</th>
                <th>Topic</th>
                <th>Possible choices</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="question-table-body">
                {% for question in questions %}
                    <tr>
                        <td>{{ question.id }}</td>
                        <td>{{ question.question }}</td>
                        <td>
                            {% for key, value in topics %}
                                {% if value == question.topic %}
                                    {{ key }}
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            <ul>
                                {% for choice in question.choices %}
                                    <li>{{ choice.choice }}</li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td style="width: 20%;">
                            <button type="button" class="btn btn-sm btn-info edit" data-id="{{ question.id }}">Edit</button>
                            <button type="button" class="btn btn-sm btn-danger delete" data-id="{{ question.id }}">Delete</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        var index = 1;
        $('.choice-add').click(function () {
            addChoicesInputs();
        });

        function addChoicesInputs() {
            if($('#ch-'+(index-1)).val()){
                $('#add-'+(index-1)).addClass("hide");
                index++;
                if(index==2){
                    $('#choices').append("" +
                        "<div><br/><input onblur='removeChoiceInput(this)' style='display: inline-block; width: 50%;' type='text' class='form-control choice' placeholder='Choice' id='ch-"+(index-1)+"'/><span onclick='addChoicesInputs();' id='add-"+(index-1)+"' style='margin-left: 10px; font-size: large;' class='lnr lnr-plus-circle hoverable choice-add'></span>" +
                        "<br/><br/><div>");
                }else if(index<5){
                    $('#choices').append("" +
                        "<div><input onblur='removeChoiceInput(this)' style='display: inline-block; width: 50%;' type='text' class='form-control choice' placeholder='Choice' id='ch-"+(index-1)+"'/><span onclick='addChoicesInputs();' id='add-"+(index-1)+"' style='margin-left: 10px; font-size: large;' class='lnr lnr-plus-circle hoverable choice-add'></span>" +
                        "<br/><br/></div>");
                }else{
                    $('#choices').append("" +
                        "<div><input onblur='removeChoiceInput(this)' style='display: inline-block; width: 50%;' type='text' class='form-control choice' placeholder='Choice' id='ch-"+(index-1)+"'/>" +
                        "</div>");
                }
                $('#ch-'+(index-1)).focus();
            }
        }
        
        function removeChoiceInput(node) {
            if(!$(node).val()){
                $(node).parent().remove();
                index--;
                $('#add-'+(index-1)).removeClass('hide');
                $('#ch-'+(index-1)).focus();
            }
        }

        $('#add_question-btn').click(function () {
            var topics = JSON.parse('{{ topics|json_encode|raw }}')
            $('#topic').html('<option value="null" disabled selected>Select a topic</option>');
            $.each(topics, function (k, el) {
                $('#topic').append('<option value="'+el+'">'+k+'</option>');
            });
            $('#question-form-modal').modal('show');
        });

        $('.edit').click(function () {
            alert($(this).data('id'));
        });

        $('.delete').click(function () {
            if(confirm("Do you want to delete this question?")){
                var questionId = $(this).data('id');
                $.ajax({
                    type: "POST",
                    url: "{{ path('admin_question_delete') }}",
                    data: { id : questionId},
                    success: function (data) {
                        updateQuestionTable();
                    }
                });
            }
        })
        
        function updateQuestionTable() {
            $.ajax({
                type: "POST",
                url: "{{ path('admin_get_questions') }}",
                success: function (data) {
                    $('#question-table-body').html('');
                    $.each(data, function (k, el) {
                        var topic = "{% for key, value in topics %}{% if value == "+el.topic+" %}{{ key }}{% endif %}{% endfor %}";
                        var choiceString = '';
                        $.each(el.choices, function (kk, ell) {
                           choiceString+="<li>"+ell.choice+"</li>";
                        });
                        $('#question-table-body').append("" +
                            "<tr>\n" +
                            "   <td>"+el.id+"</td>\n" +
                            "   <td>"+el.question+"</td>\n" +
                            "   <td>"+topic+"</td>\n" +
                            "   <td>\n" +
                            "       <ul>"+choiceString+"</ul>\n" +
                            "   </td>\n" +
                            "   <td style=\"width: 20%;\">\n" +
                            "       <button type=\"button\" class=\"btn btn-sm btn-info edit\" data-id=\""+el.id+"\">Edit</button>\n" +
                            "       <buttontype=\"button\" class=\"btn btn-sm btn-danger delete\" data-id=\""+el.id+"\">Delete</button>\n" +
                            "   </td>\n" +
                            "</tr>" +
                            "");
                    });
                }
            });
        }
    </script>
{% endblock %}